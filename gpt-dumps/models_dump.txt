===== GPT DUMP GENERATED: 2025-11-10T06:46:40Z =====
===== DIRECTORY: app/Models =====

app/Models/TickerIndicator.php


===== FILE: app/Models/TickerIndicator.php =====

<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Carbon;

class TickerIndicator extends Model
{
    use HasFactory;

    protected $table = 'ticker_indicators';

    protected $fillable = [
        'ticker_id',
        'resolution',
        't',
        'indicator',
        'value',
        'meta',
    ];

    protected $casts = [
        't' => 'datetime',
        'meta' => 'array',
        'value' => 'float',
    ];

    public function ticker()
    {
        return $this->belongsTo(Ticker::class);
    }

    /** Scope: by symbol (joins ticker) */
    public function scopeForTicker($query, string $symbol)
    {
        return $query->whereHas('ticker', fn($q) => $q->where('ticker', strtoupper($symbol)));
    }

    /** Scope: by indicator name */
    public function scopeIndicator($query, string $name)
    {
        return $query->where('indicator', $name);
    }

    /** Scope: recent N trading days */
    public function scopeSince($query, string $date)
    {
        return $query->where('t', '>=', $date);
    }

    public function getDateAttribute(): ?string
    {
        return $this->t ? Carbon::parse($this->t)->toDateString() : null;
    }
}
app/Models/TickerFeatureSnapshot.php


===== FILE: app/Models/TickerFeatureSnapshot.php =====

<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

/**
 * Class TickerFeatureSnapshot
 *
 * Represents a compact JSON "feature vector" of all computed indicators and analytics
 * for a given ticker and date. Serves as an AI-ready, ML-friendly dataset structure.
 *
 * Example:
 *   {
 *     "sma_20": 142.54,
 *     "ema_12": 144.21,
 *     "rsi_14": 63.2,
 *     "macd": 0.84,
 *     "atr_14": 1.13,
 *     "boll_20_upper": 146.2,
 *     "boll_20_lower": 138.9,
 *     "beta_60": 1.07,
 *     "sharpe_60": 0.94
 *   }
 *
 * Each record corresponds to a unique (ticker_id, t) pair.
 */
class TickerFeatureSnapshot extends Model
{
    protected $table = 'ticker_feature_snapshots';

    protected $fillable = [
        'ticker_id',
        't',
        'indicators',
        'embedding',
    ];

    protected $casts = [
        't' => 'date',
        'indicators' => 'array',
        'embedding' => 'array',
    ];

    /**
     * Relationships
     */
    public function ticker()
    {
        return $this->belongsTo(Ticker::class);
    }
}app/Models/TickerNewsItem.php


===== FILE: app/Models/TickerNewsItem.php =====

<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Carbon;

class TickerNewsItem extends Model
{
    use HasFactory;

    /**
     * This table is ingestion-only, so we’ll guard nothing to simplify updates.
     * If you later expose a writable API endpoint, switch to $fillable for safety.
     */
    protected $guarded = [];

    /**
     * Attribute casting.
     * - Arrays are automatically converted to JSON for storage.
     * - Dates use Carbon for easy formatting.
     */
    protected $casts = [
        'published_utc' => 'datetime',
        'tickers_list'  => 'array',
        'keywords'      => 'array',
        'insights'      => 'array',
        'raw'           => 'array',
    ];

    /**
     * Relationships
     */
    public function ticker()
    {
        return $this->belongsTo(Ticker::class);
    }

    /**
     * Query Scopes
     */

    // Limit to recent news items (default: past 7 days)
    public function scopeRecent($query, int $days = 7)
    {
        return $query->where('published_utc', '>=', now()->subDays($days));
    }

    // Limit to a specific ticker symbol
    public function scopeForTicker($query, string $symbol)
    {
        return $query->where('ticker', strtoupper($symbol));
    }

    // Filter by sentiment
    public function scopeWithSentiment($query, ?string $sentiment = null)
    {
        if ($sentiment) {
            return $query->where('insight_sentiment', strtolower($sentiment));
        }
        return $query->whereNotNull('insight_sentiment');
    }

    /**
     * Accessors
     */

    // Human-readable date
    public function getPublishedDateAttribute(): ?string
    {
        return $this->published_utc
            ? Carbon::parse($this->published_utc)->toDateString()
            : null;
    }

    // Short summary preview
    public function getSummaryExcerptAttribute(): ?string
    {
        return $this->summary
            ? mb_strimwidth($this->summary, 0, 140, '…')
            : null;
    }

    // Display publisher name fallback
    public function getPublisherDisplayAttribute(): ?string
    {
        return $this->publisher_name ?? 'Unknown Source';
    }
}app/Models/TickerPriceHistory.php


===== FILE: app/Models/TickerPriceHistory.php =====

<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class TickerPriceHistory extends Model
{
    use HasFactory;

    protected $table = 'ticker_price_histories';

    protected $fillable = [
        'ticker_id',
        'o',
        'h',
        'l',
        'c',
        'v',
        'vw',
        't',
        'year',
    ];

    protected $casts = [
        't' => 'datetime',
        'o' => 'float',
        'h' => 'float',
        'l' => 'float',
        'c' => 'float',
        'v' => 'float',
        'vw' => 'float',
        'year' => 'integer',
    ];

    public function ticker()
    {
        return $this->belongsTo(Ticker::class);
    }

    /**
     * Scope for filtering by year.
     */
    public function scopeYear($query, int $year)
    {
        return $query->where('year', $year);
    }
}app/Models/TickerCorrelation.php


===== FILE: app/Models/TickerCorrelation.php =====

<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

/**
 * TickerCorrelation
 *
 * Stores pairwise correlation metrics between two tickers on a given date.
 */
class TickerCorrelation extends Model
{
    protected $fillable = [
        'ticker_id_a',
        'ticker_id_b',
        'as_of_date',
        'corr',
        'beta',
        'r2',
    ];

    protected $casts = [
        'as_of_date' => 'date',
        'corr' => 'float',
        'beta' => 'float',
        'r2' => 'float',
    ];

    public $timestamps = true;
}
app/Models/LatestTickerPrice.php


===== FILE: app/Models/LatestTickerPrice.php =====

<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class LatestTickerPrice extends Model
{
    protected $table = 'latest_ticker_prices';

    // This model is read-only (it's a SQL VIEW)
    public $timestamps = false;
    protected $guarded = [];

    public static function forTicker(string $ticker)
    {
        return static::where('ticker', $ticker)->first();
    }

    // Optional: make it cast values properly
    protected $casts = [
        't' => 'datetime',
        'o' => 'float', // open
        'h' => 'float', // high
        'l' => 'float', // low
        'c' => 'float', // close
        'v' => 'float', // volume
    ];
}app/Models/DataIntegrityLog.php


===== FILE: app/Models/DataIntegrityLog.php =====

<?php

namespace App\Models;

/**
 * ============================================================================
 *  DataIntegrityLog (alias of DataValidationLog)
 * ============================================================================
 *
 * A logical alias of DataValidationLog that specifically tracks
 * *integrity-level* audits (e.g., null checks, duplicate detection,
 * orphaned foreign keys, or schema anomalies).
 *
 * Uses the same underlying table `data_validation_logs`.
 * ============================================================================
 */
class DataIntegrityLog extends DataValidationLog
{
    // Uses same fillable, casts, and table
}
app/Models/TickerAnalysis.php


===== FILE: app/Models/TickerAnalysis.php =====

<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class TickerAnalysis extends Model
{
    protected $fillable = [
        'ticker','user_id','provider','model','request_payload','response_raw',
        'summary','structured','status','requested_at','completed_at',
    ];

    protected $casts = [
        'request_payload' => 'array',
        'response_raw' => 'array',
        'structured' => 'array',
        'requested_at' => 'datetime',
        'completed_at' => 'datetime',
    ];

    public function user() { return $this->belongsTo(User::class); }
}app/Models/User.php


===== FILE: app/Models/User.php =====

<?php

namespace App\Models;

use Illuminate\Contracts\Auth\MustVerifyEmail;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;
use Laravel\Fortify\TwoFactorAuthenticatable;

class User extends Authenticatable implements MustVerifyEmail
{
    /** @use HasFactory<\Database\Factories\UserFactory> */
    use HasFactory, Notifiable, TwoFactorAuthenticatable;

    /**
     * The attributes that are mass assignable.
     *
     * @var list<string>
     */
    protected $fillable = [
        'name',
        'email',
        'password',
    ];

    /**
     * The attributes that should be hidden for serialization.
     *
     * @var list<string>
     */
    protected $hidden = [
        'password',
        'two_factor_secret',
        'two_factor_recovery_codes',
        'remember_token',
    ];

    /**
     * Get the attributes that should be cast.
     *
     * @return array<string, string>
     */
    protected function casts(): array
    {
        return [
            'email_verified_at' => 'datetime',
            'password' => 'hashed',
            'two_factor_confirmed_at' => 'datetime',
        ];
    }
}app/Models/Ticker.php


===== FILE: app/Models/Ticker.php =====

<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Str;

/**
 * Model: Ticker
 *
 * Represents a single financial instrument reference entity
 * (stock, ETF, crypto, etc.) as defined by Polygon.io’s /v3/reference/tickers.
 *
 * This table holds *static or slowly changing* metadata such as company info,
 * identifiers, and branding.
 */
class Ticker extends Model
{
    use HasFactory;

    /**
     * Mass-assignable fields.
     *
     * Includes core Polygon reference fields + enriched metadata fields.
     */
    protected $fillable = [
        // --- Core fields from Polygon.io /v3/reference/tickers ---
        'ticker',
        'name',
        'market',
        'locale',
        'primary_exchange',
        'type',
        'status',
        'active',
        'currency_symbol',
        'currency_name',
        'base_currency_symbol',
        'base_currency_name',
        'cik',
        'composite_figi',
        'share_class_figi',
        'last_updated_utc',
        'delisted_utc',
        'raw',

        // --- Enriched / Overview metadata ---
        'description',
        'homepage_url',
        'list_date',
        'phone_number',
        'total_employees',
        'sic_code',
        'sic_description',
        'share_class_shares_outstanding',
        'weighted_shares_outstanding',
        'ticker_root',
        'ticker_suffix',
        'round_lot',
        'branding_logo_url',
        'branding_icon_url',
        'address_json',
    ];

    /**
     * Attribute casting for consistent data handling.
     */
    protected $casts = [
        'active'                        => 'boolean',
        'raw'                           => 'array',
        'last_updated_utc'              => 'datetime',
        'delisted_utc'                  => 'datetime',
        'list_date'                     => 'date',
        'total_employees'               => 'integer',
        'share_class_shares_outstanding'=> 'integer',
        'weighted_shares_outstanding'   => 'integer',
        'round_lot'                     => 'integer',
        'address_json'                  => 'array',
    ];

    public $timestamps = true;

    /* -----------------------------------------------------------------
     |  Relationships
     | -----------------------------------------------------------------
     */

    public function overviews()
    {
        return $this->hasMany(TickerOverview::class, 'ticker_id');
    }

    public function overview()
    {
        return $this->hasOne(TickerOverview::class, 'ticker_id')->latestOfMany();
    }

    public function fundamentals()
    {
        return $this->hasMany(TickerFundamental::class, 'ticker_id');
    }

    public function priceHistories()
    {
        return $this->hasMany(TickerPriceHistory::class, 'ticker_id');
    }

    public function indicators()
    {
        return $this->hasMany(TickerIndicator::class, 'ticker_id');
    }

    public function analyses()
    {
        return $this->hasMany(TickerAnalysis::class, 'ticker', 'ticker');
    }

    public function analysis()
    {
        return $this->hasOne(TickerAnalysis::class, 'ticker', 'ticker')->latestOfMany();
    }

    public function newsItems()
    {
        return $this->hasMany(TickerNewsItem::class, 'ticker_id');
    }

    /* -----------------------------------------------------------------
     |  Accessors & Utilities
     | -----------------------------------------------------------------
     */

    public function getSlugAttribute($value): string
    {
        return $value ?: Str::slug($this->name ?? $this->ticker);
    }

    public function getLocationAttribute(): ?string
    {
        if (!$this->address_json || !is_array($this->address_json)) {
            return null;
        }

        $city  = $this->address_json['city']  ?? null;
        $state = $this->address_json['state'] ?? null;

        return $city && $state ? "{$city}, {$state}" : ($city ?? $state ?? null);
    }

    public function getFormattedEmployeeCountAttribute(): ?string
    {
        return $this->total_employees
            ? number_format($this->total_employees)
            : null;
    }

    public function latestPrice(): ?TickerPriceHistory
    {
        return $this->priceHistories()->latest('t')->first();
    }

    public function latestIndicators(): ?TickerIndicator
    {
        return $this->indicators()->latest('t')->first();
    }

    /* -----------------------------------------------------------------
     |  Scopes
     | -----------------------------------------------------------------
     */

    public function scopeActive($query)
    {
        return $query->where('active', true);
    }

    public function scopeBySymbol($query, string $symbol)
    {
        return $query->whereRaw('LOWER(ticker) = ?', [strtolower($symbol)]);
    }
}app/Models/DataValidationLog.php


===== FILE: app/Models/DataValidationLog.php =====

<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

/**
 * ============================================================================
 *  DataValidationLog
 * ============================================================================
 *
 * Represents a persisted record of a validation run — used by:
 *  - tickers:validate-data
 *  - tickers:integrity-scan
 *  - (future) sentiment & fundamentals validation jobs
 *
 * Each record stores summary metrics, details JSON, and run metadata.
 * ============================================================================
 */
class DataValidationLog extends Model
{
    protected $table = 'data_validation_logs';

    protected $fillable = [
        'entity_type',
        'command_name',
        'total_entities',
        'validated_count',
        'missing_count',
        'details',
        'status',
        'started_at',
        'completed_at',
        'initiated_by',
    ];

    protected $casts = [
        'details' => 'array',
        'started_at' => 'datetime',
        'completed_at' => 'datetime',
    ];
}app/Models/JobBatch.php


===== FILE: app/Models/JobBatch.php =====

<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Str;

/**
 * ============================================================================
 *  JobBatch Model (Final - Eloquent-safe)
 * ============================================================================
 *
 * Represents records in the `job_batches` table, used by:
 *   • Laravel's native Bus batching system
 *   • TickerWolf's custom ingestion monitoring layer
 *
 * Key behaviors:
 *   • UUID primary keys
 *   • Hybrid timestamp model:
 *       - created_at, finished_at, cancelled_at → UNIX epoch (INT)
 *       - updated_at → DATETIME (timestamp)
 *   • Disables Eloquent’s built-in timestamp mutation to prevent
 *     overwriting of integer timestamps with formatted datetime strings.
 * ============================================================================
 */
class JobBatch extends Model
{
    use HasFactory;

    /** @var string The table associated with this model. */
    protected $table = 'job_batches';

    /** @var bool Indicates if the model's primary key is auto-incrementing. */
    public $incrementing = false;

    /** @var string The data type of the primary key. */
    protected $keyType = 'string';

    /**
     * Disable automatic timestamp management.
     *
     * We handle created_at/updated_at manually to keep schema consistency.
     */
    public $timestamps = false; // ✅ CRUCIAL FIX

    /** @var array Attributes that can be mass-assigned. */
    protected $fillable = [
        'id',
        'name',
        'total_jobs',
        'pending_jobs',
        'processed_jobs',
        'failed_jobs',
        'status',
        'created_at',
        'updated_at',
    ];

    /** @var array Attribute casting definitions. */
    protected $casts = [
        'total_jobs'     => 'integer',
        'pending_jobs'   => 'integer',
        'processed_jobs' => 'integer',
        'failed_jobs'    => 'integer',
        'created_at'     => 'integer',   // UNIX timestamp
        'updated_at'     => 'datetime',  // full timestamp
    ];

    /**
     * Boot the model and handle UUID + manual timestamps.
     */
    protected static function booted(): void
    {
        static::creating(function ($model) {
            // Generate UUID primary key
            if (empty($model->{$model->getKeyName()})) {
                $model->{$model->getKeyName()} = (string) Str::uuid();
            }

            // Only set timestamps manually
            if (empty($model->created_at)) {
                $model->created_at = now()->getTimestamp();
            }
            if (empty($model->updated_at)) {
                $model->updated_at = now();
            }
        });
    }

    /* ----------------------------------------------------------------------
     |  Domain convenience helpers
     | ---------------------------------------------------------------------- */

    /** Determine if the batch is complete. */
    public function isComplete(): bool
    {
        return $this->pending_jobs <= 0 && $this->failed_jobs === 0;
    }

    /** Determine if the batch has failures. */
    public function hasFailures(): bool
    {
        return $this->failed_jobs > 0;
    }

    /** Mark the batch as complete. */
    public function markComplete(): void
    {
        $this->update(['status' => 'complete']);
    }

    /** Mark the batch as failed. */
    public function markFailed(): void
    {
        $this->update(['status' => 'failed']);
    }
}app/Models/TickerOverview.php


===== FILE: app/Models/TickerOverview.php =====

<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Carbon;

/**
 * Model: TickerOverview
 *
 * Represents a daily snapshot of a ticker’s volatile attributes
 * (market cap, active status, etc.) fetched from Polygon.io.
 *
 * This table stores time-variant metrics and raw API responses
 * for auditing and reprocessing historical data.
 */
class TickerOverview extends Model
{
    use HasFactory;

    /**
     * Explicit table name for clarity.
     */
    protected $table = 'ticker_overviews';

    /**
     * Mass-assignable attributes.
     *
     * Only include fields that actually exist in the ticker_overviews table
     * (after schema cleanup).
     */
    protected $fillable = [
        'ticker_id',
        'overview_date',
        'active',
        'market_cap',
        'status',
        'results_raw',
        'fetched_at',
        'created_at',
        'updated_at',
    ];

    /**
     * Attribute casting for correct data types.
     */
    protected $casts = [
        'active'        => 'boolean',
        'market_cap'    => 'integer',
        'results_raw'   => 'array',
        'overview_date' => 'date',
        'fetched_at'    => 'datetime',
    ];

    /**
     * Relationships
     * -----------------------------------------------------------------
     */

    /**
     * Each overview belongs to a single ticker.
     */
    public function ticker()
    {
        return $this->belongsTo(Ticker::class);
    }

    /**
     * Scopes
     * -----------------------------------------------------------------
     */

    /**
     * Scope: fetch only the latest overview for each ticker.
     *
     * Note:
     * Uses a subquery for MySQL/MariaDB to retrieve the latest ID per ticker.
     */
    public function scopeLatestForEachTicker(Builder $query): Builder
    {
        return $query->whereIn('id', function ($sub) {
            $sub->selectRaw('MAX(id)')
                ->from('ticker_overviews')
                ->groupBy('ticker_id');
        });
    }

    /**
     * Accessors
     * -----------------------------------------------------------------
     */

    /**
     * Nicely formatted market cap for display (e.g., $1.25B).
     */
    public function getFormattedMarketCapAttribute(): ?string
    {
        if (! $this->market_cap) {
            return null;
        }

        $value = $this->market_cap;

        if ($value >= 1_000_000_000) {
            return '$' . number_format($value / 1_000_000_000, 2) . 'B';
        } elseif ($value >= 1_000_000) {
            return '$' . number_format($value / 1_000_000, 2) . 'M';
        }

        return '$' . number_format($value);
    }

    /**
     * Derived convenience accessor for ticker symbol.
     */
    public function getSymbolAttribute(): ?string
    {
        return optional($this->ticker)->ticker;
    }

    /**
     * Utility: Create or update overview record from a Polygon API response.
     *
     * @param  \App\Models\Ticker  $ticker
     * @param  array  $polygonData  Raw Polygon.io results
     * @return static
     */
    public static function fromPolygonResponse(Ticker $ticker, array $polygonData): self
    {
        $parsed = [
            'ticker_id'     => $ticker->id,
            'overview_date' => now()->toDateString(),
            'active'        => $polygonData['active'] ?? null,
            'market_cap'    => $polygonData['market_cap'] ?? null,
            'status'        => $polygonData['status'] ?? (
                ($polygonData['active'] ?? false) ? 'active' : 'inactive'
            ),
            'results_raw'   => $polygonData,
            'fetched_at'    => now(),
        ];

        return static::updateOrCreate(
            ['ticker_id' => $ticker->id, 'overview_date' => $parsed['overview_date']],
            $parsed
        );
    }
}app/Models/TickerFundamental.php


===== FILE: app/Models/TickerFundamental.php =====

<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Factories\HasFactory;

class TickerFundamental extends Model
{
    use HasFactory;

    protected $table = 'ticker_fundamentals';

    // This table is ingestion-only; easiest is to allow all mass assignment:
    protected $guarded = [];

    protected $casts = [
        'start_date'            => 'date',
        'end_date'              => 'date',
        'filing_date'           => 'date',
        'balance_sheet'         => 'array',
        'income_statement'      => 'array',
        'cash_flow_statement'   => 'array',
        'comprehensive_income'  => 'array',
        'raw'                   => 'array',
        'fetched_at'            => 'datetime',
    ];

    public function ticker()
    {
        return $this->belongsTo(Ticker::class);
    }

    public function metrics()
    {
        return $this->hasMany(TickerFundamentalMetric::class, 'fundamental_id');
    }
}app/Models/TickerFundamentalMetric.php


===== FILE: app/Models/TickerFundamentalMetric.php =====

<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class TickerFundamentalMetric extends Model
{
    use HasFactory;

    protected $table = 'ticker_fundamentals_financials';

    protected $fillable = [
        'ticker_id', 'fundamental_id', 'ticker', 'statement', 'line_item',
        'label', 'unit', 'display_order', 'value',
        'end_date', 'fiscal_period', 'fiscal_year',
    ];

    protected $casts = [
        'value' => 'float',
        'display_order' => 'integer',
        'end_date' => 'date',
        'created_at' => 'datetime',
        'updated_at' => 'datetime',
    ];

    public function ticker()
    {
        return $this->belongsTo(Ticker::class);
    }

    public function fundamental()
    {
        return $this->belongsTo(TickerFundamental::class, 'fundamental_id');
    }
}
[EOF: app/Models]
