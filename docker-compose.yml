services:

  # ------------------------------------------------------
  # PHP FPM – main application runtime
  # ------------------------------------------------------
  php:
    build:
      context: ./
      dockerfile: docker/php/Dockerfile-8.4
    container_name: tickerwolf-php
    restart: unless-stopped
    tty: true
    working_dir: /www/websites/tickerwolf.ai
    environment:
      - COMPOSER_MEMORY_LIMIT=-1
      - PHP_MEMORY_LIMIT=2G
    volumes:
      - ./:/www/websites/tickerwolf.ai
      - ./storage:/www/websites/tickerwolf.ai/storage:rw
      - ./bootstrap/cache:/www/websites/tickerwolf.ai/bootstrap/cache:rw
      - ./docker/php/php-ini-overrides.ini:/usr/local/etc/php/conf.d/99-overrides.ini
      - ./docker/php/xdebug.ini:/usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
    depends_on:
      - mariadb
      - redis

  # ------------------------------------------------------
  # Laravel Scheduler – runs schedule:run every 60 seconds
  # ------------------------------------------------------
  scheduler:
    build:
      context: ./
      dockerfile: docker/php/Dockerfile-8.4
    container_name: tickerwolf-scheduler
    restart: unless-stopped
    tty: true
    working_dir: /www/websites/tickerwolf.ai
    environment:
      - COMPOSER_MEMORY_LIMIT=-1
      - PHP_MEMORY_LIMIT=2G
    volumes:
      - ./:/www/websites/tickerwolf.ai
      - ./storage:/www/websites/tickerwolf.ai/storage:rw
      - ./bootstrap/cache:/www/websites/tickerwolf.ai/bootstrap/cache:rw
      - ./docker/php/php-ini-overrides.ini:/usr/local/etc/php/conf.d/99-overrides.ini
      - ./docker/php/xdebug.ini:/usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
    depends_on:
      php:
        condition: service_started
      mariadb:
        condition: service_healthy
      redis:
        condition: service_started

    # ALPINE-SAFE (single line)
    command: >
      sh -c "while true; do php artisan schedule:run --verbose --no-interaction; sleep 60; done"

  # ------------------------------------------------------
  # Dedicated Queue Worker (Supervisor model)
  # ------------------------------------------------------
  queue:
    build:
      context: ./
      dockerfile: docker/php/Dockerfile-8.4
    container_name: tickerwolf-queue
    restart: unless-stopped
    tty: true
    working_dir: /www/websites/tickerwolf.ai
    environment:
      - COMPOSER_MEMORY_LIMIT=-1
      - PHP_MEMORY_LIMIT=2G

      - QUEUE_WORKER_QUEUE=${QUEUE_WORKER_QUEUE:-default}
      - QUEUE_WORKER_SLEEP=${QUEUE_WORKER_SLEEP:-3}
      - QUEUE_WORKER_BACKOFF=${QUEUE_WORKER_BACKOFF:-5}

      # Safe defaults for large multi-ticker jobs
      - QUEUE_WORKER_MAX_JOBS=${QUEUE_WORKER_MAX_JOBS:-10}
      - QUEUE_WORKER_MAX_TIME=${QUEUE_WORKER_MAX_TIME:-900}     # 15 minutes
      - QUEUE_WORKER_TRIES=${QUEUE_WORKER_TRIES:-3}
      - QUEUE_WORKER_TIMEOUT=${QUEUE_WORKER_TIMEOUT:-300}       # 5 minutes

    volumes:
      - ./:/www/websites/tickerwolf.ai
      - ./storage:/www/websites/tickerwolf.ai/storage:rw
      - ./bootstrap/cache:/www/websites/tickerwolf.ai/bootstrap/cache:rw
      - ./docker/php/php-ini-overrides.ini:/usr/local/etc/php/conf.d/99-overrides.ini
      - ./docker/php/xdebug.ini:/usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
    depends_on:
      mariadb:
        condition: service_healthy
      redis:
        condition: service_started
      php:
        condition: service_started

    # ⭐ ALPINE-SAFE — SINGLE-LINE queue worker command
    command: >
      sh -c "while true; do php artisan queue:work --queue=${QUEUE_WORKER_QUEUE:-default} --sleep=${QUEUE_WORKER_SLEEP:-3} --backoff=${QUEUE_WORKER_BACKOFF:-5} --max-jobs=${QUEUE_WORKER_MAX_JOBS:-10} --max-time=${QUEUE_WORKER_MAX_TIME:-900} --tries=${QUEUE_WORKER_TRIES:-3} --timeout=${QUEUE_WORKER_TIMEOUT:-300} --memory=2048; EXIT_CODE=$?; echo \"queue:work exited with code $EXIT_CODE\"; sleep 5; done"

  # ------------------------------------------------------
  # Redis – caching & intraday data storage
  # ------------------------------------------------------
  redis:
    image: redis:alpine
    container_name: tickerwolf-redis
    restart: unless-stopped
    tty: true
    volumes:
      - redis-data:/data:delegated
    ports:
      - "6379:6379"

  # ------------------------------------------------------
  # MariaDB – high-volume OHLCV + fundamentals store
  # ------------------------------------------------------
  mariadb:
    image: mariadb:10.11
    container_name: tickerwolf-mariadb
    restart: unless-stopped
    tty: true
    mem_limit: 8g
    shm_size: 2g
    volumes:
      - mariadb-data:/var/lib/mysql
      - ./docker/mariadb/conf.d:/etc/mysql/conf.d
    environment:
      - MARIADB_ROOT_PASSWORD=!tickerwolf91923!
      - MARIADB_DATABASE=tickerwolf
      - MARIADB_USER=tickerwolf
      - MARIADB_PASSWORD=!tickerwolf91923!
      - MARIADB_AUTO_UPGRADE=true
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-u", "root", "-p!tickerwolf91923!"]
      interval: 5s
      timeout: 5s
      retries: 20

  # ------------------------------------------------------
  # NGINX – serves the Laravel app
  # ------------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: tickerwolf-nginx
    restart: unless-stopped
    tty: true
    working_dir: /www/websites/tickerwolf.ai
    volumes:
      - .:/www/websites/tickerwolf.ai:delegated
      - ./docker/nginx/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - mariadb
      - redis
      - php
    ports:
      - "80:80"

  # ------------------------------------------------------
  # Vite – hot reloading (Vue + Inertia)
  # ------------------------------------------------------
  vite:
    image: node:22-alpine
    container_name: tickerwolf-vite
    restart: unless-stopped
    working_dir: /www/websites/tickerwolf.ai
    environment:
      NODE_ENV: development
    volumes:
      - ./:/www/websites/tickerwolf.ai
      - vite-node-modules:/www/websites/tickerwolf.ai/node_modules
    ports:
      - "5173:5173"
    command: >
      sh -c "npm install && npm run dev -- --host 0.0.0.0 --port 5173 --strictPort"
    depends_on:
      - php

volumes:
  mariadb-data:
    driver: local
  redis-data:
    driver: local
  vite-node-modules:
    driver: local