===== GPT DUMP GENERATED: 2025-11-13T22:06:49Z =====
===== DATABASE MIGRATIONS (Part 2 - Remaining Files) =====



===== FILE: database/migrations/2025_10_25_193123_add_timestamps_to_failed_ticker_overviews_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('failed_ticker_overviews', function (Blueprint $table) {
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('failed_ticker_overviews', function (Blueprint $table) {
            $table->dropTimestamps();
        });
    }
};


===== FILE: database/migrations/2025_10_25_231557_create_ticker_price_histories_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {

    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('ticker_price_histories', function (Blueprint $table) {
            $table->id();
            $table->foreignId('ticker_id')->constrained('tickers')->cascadeOnDelete();
            $table->string('ticker', 16)->index();
            $table->string('resolution', 8)->default('1d')->index(); // 1m, 5m, 15m, 1d, etc.
            $table->timestamp('t')->index(); // timestamp of bar (UTC)
            $table->decimal('o', 16, 6)->nullable();
            $table->decimal('h', 16, 6)->nullable();
            $table->decimal('l', 16, 6)->nullable();
            $table->decimal('c', 16, 6)->nullable();
            $table->bigInteger('v')->nullable();
            $table->json('raw')->nullable();
            $table->unique(['ticker_id', 'resolution', 't']);
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('ticker_price_histories');
    }
};

===== FILE: database/migrations/2025_10_25_231714_create_ticker_indicators_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {

    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('ticker_indicators', function (Blueprint $table) {
            $table->id();
            $table->foreignId('ticker_id')->constrained('tickers')->cascadeOnDelete();
            $table->string('resolution', 8)->default('1d')->index();
            $table->timestamp('t')->index();
            $table->string('indicator')->index(); // e.g. sma_20, ema_50, rsi_14
            $table->decimal('value', 24, 8)->nullable();
            $table->json('meta')->nullable(); // For complex indicators (MACD, Bollinger)
            $table->unique(['ticker_id', 'resolution', 't', 'indicator']);
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('ticker_indicators');
    }
};

===== FILE: database/migrations/2025_10_25_231845_create_ticker_news_items_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {

    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('ticker_news_items', function (Blueprint $table) {
            $table->id();
            $table->foreignId('ticker_id')->nullable()->constrained('tickers')->nullOnDelete()->index();
            $table->string('ticker', 16)->nullable()->index();
            $table->string('source')->nullable();
            $table->string('url')->nullable();
            $table->string('title')->nullable();
            $table->text('summary')->nullable();
            $table->timestamp('published_at')->nullable()->index();
            $table->json('raw')->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('ticker_news_items');
    }
};

===== FILE: database/migrations/2025_10_26_011635_optimize_ticker_price_histories_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

return new class extends Migration
{
    /**
     * NOTE:
     * - This migration is intentionally defensive. It will:
     *   1) Add a generated column `t_year` storing YEAR(t)
     *   2) Create helpful indexes for common queries
     *   3) Attempt to partition the table by YEAR using RANGE on t_year
     *
     * WARNING:
     * - Partitioning an existing large table may take a long time and lock the table.
     * - Test in staging and/or run during a maintenance window.
     */

    /**
     * Run the migrations.
     */
    public function up(): void
    {
        $table = 'ticker_price_histories';

        // 1) Add generated column t_year if it doesn't exist
        $hasColumn = DB::selectOne("SELECT COUNT(*) AS cnt FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = ? AND COLUMN_NAME = 't_year'", [$table])->cnt ?? 0;
        if (! $hasColumn) {
            // Use STORED generated column so it can be indexed and used for partitioning
            DB::statement("ALTER TABLE `{$table}` ADD COLUMN `t_year` INT GENERATED ALWAYS AS (YEAR(`t`)) STORED");
        }

        // 2) Add / ensure indexes
        // Composite index for (ticker_id, resolution, t) - useful for time-range queries per ticker
        $indexExists = DB::selectOne("SELECT COUNT(*) AS cnt FROM INFORMATION_SCHEMA.STATISTICS WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = ? AND INDEX_NAME = 'idx_ticker_resolution_t'", [$table])->cnt ?? 0;
        if (! $indexExists) {
            DB::statement("CREATE INDEX idx_ticker_resolution_t ON `{$table}` (`ticker_id`, `resolution`, `t`)");
        }

        // Index by date (t) for range queries across tickers
        $idxT = DB::selectOne("SELECT COUNT(*) AS cnt FROM INFORMATION_SCHEMA.STATISTICS WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = ? AND INDEX_NAME = 'idx_t'", [$table])->cnt ?? 0;
        if (! $idxT) {
            DB::statement("CREATE INDEX idx_t ON `{$table}` (`t`)");
        }

        // Index on t_year to help partition pruning / queries
        $idxYear = DB::selectOne("SELECT COUNT(*) AS cnt FROM INFORMATION_SCHEMA.STATISTICS WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = ? AND INDEX_NAME = 'idx_t_year'", [$table])->cnt ?? 0;
        if (! $idxYear) {
            DB::statement("CREATE INDEX idx_t_year ON `{$table}` (`t_year`)");
        }

        // 3) Attempt to partition the table by RANGE on t_year
        // Build partitions from 2015 through next year, plus MAXVALUE
        $currentYear = (int) date('Y');
        $startYear = 2015;
        $endYear = $currentYear + 1;

        // Check if the table is already partitioned
        $isPartitioned = DB::selectOne("SELECT COUNT(*) AS cnt FROM INFORMATION_SCHEMA.PARTITIONS WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = ?", [$table])->cnt ?? 0;

        if (! $isPartitioned) {
            $parts = [];
            for ($y = $startYear; $y <= $endYear; $y++) {
                $label = "p{$y}";
                $lessThan = $y + 1; // partition holds years < (y+1) => year == y
                $parts[] = "PARTITION `{$label}` VALUES LESS THAN ({$lessThan})";
            }
            $parts[] = "PARTITION `pmax` VALUES LESS THAN (MAXVALUE)";
            $partSql = implode(",\n    ", $parts);

            $partitionStmt = "ALTER TABLE `{$table}` PARTITION BY RANGE (`t_year`) (\n    {$partSql}\n)";

            // Try to run partitioning; wrap in try/catch because this may fail on some engines or existing data.
            try {
                DB::statement($partitionStmt);
            } catch (\Throwable $e) {
                // Partitioning can fail on large tables or specific server configs.
                // Log the error to the Laravel log and continue; an operator can run partitioning manually.
                \Illuminate\Support\Facades\Log::warning("Partitioning attempt failed for {$table}: " . $e->getMessage());
            }
        }
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        $table = 'ticker_price_histories';

        // Remove partitioning if present - this operation can be heavy.
        try {
            // Only try if partitions exist
            $isPartitioned = DB::selectOne("SELECT COUNT(*) AS cnt FROM INFORMATION_SCHEMA.PARTITIONS WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = ?", [$table])->cnt ?? 0;
            if ($isPartitioned) {
                DB::statement("ALTER TABLE `{$table}` REMOVE PARTITIONING");
            }
        } catch (\Throwable $e) {
            \Illuminate\Support\Facades\Log::warning("Failed to remove partitioning for {$table}: " . $e->getMessage());
        }

        // Drop the generated column if it exists
        $hasColumn = DB::selectOne("SELECT COUNT(*) AS cnt FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = ? AND COLUMN_NAME = 't_year'", [$table])->cnt ?? 0;
        if ($hasColumn) {
            DB::statement("ALTER TABLE `{$table}` DROP COLUMN `t_year`");
        }

        // Drop indexes we created (ignore errors)
        try {
            DB::statement("DROP INDEX idx_ticker_resolution_t ON `{$table}`");
        } catch (\Throwable $e) {
            // ignore
        }
        try {
            DB::statement("DROP INDEX idx_t ON `{$table}`");
        } catch (\Throwable $e) {
            // ignore
        }
        try {
            DB::statement("DROP INDEX idx_t_year ON `{$table}`");
        } catch (\Throwable $e) {
            // ignore
        }
    }
};

===== FILE: database/migrations/2025_10_26_012358_add_performance_indexes_to_ticker_price_histories_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

/**
 * ============================================================================
 *  Migration: add_performance_indexes_to_ticker_price_histories_table
 * ============================================================================
 *
 * ðŸ”§ Purpose:
 *   Adds key performance indexes and a `latest_ticker_prices` view
 *   to optimize query speed for ticker data lookups.
 *
 * ðŸ§  Design Notes:
 *   â€¢ Adds 3 indexes + 1 unique composite key for fast range & lookup queries.
 *   â€¢ Creates (or replaces) a convenience view for retrieving each tickerâ€™s
 *     latest bar data without subqueries in the application layer.
 *
 * âœ… Refresh-Safe Features:
 *   â€¢ Checks if the table exists before altering.
 *   â€¢ Verifies index existence before adding or dropping.
 *   â€¢ Catches SQL errors gracefully (migrate:refresh, CI, or re-runs).
 *   â€¢ Drops the view only if it exists.
 *
 * ============================================================================
 */
return new class extends Migration
{
    public function up(): void
    {
        $table = 'ticker_price_histories';
        $view = 'latest_ticker_prices';

        if (!Schema::hasTable($table)) {
            echo "âš ï¸  Skipping up(): '{$table}' table not found.\n";
            return;
        }

        $indexes = [
            'ticker_t_index' => ['ticker', 't'],
            'ticker_resolution_index' => ['ticker', 'resolution'],
            't_index' => ['t'],
        ];

        // Add performance indexes if missing
        foreach ($indexes as $indexName => $columns) {
            try {
                $exists = DB::selectOne("
                    SELECT COUNT(*) AS cnt
                    FROM information_schema.STATISTICS
                    WHERE TABLE_SCHEMA = DATABASE()
                      AND TABLE_NAME = ?
                      AND INDEX_NAME = ?
                ", [$table, $indexName]);

                if (($exists->cnt ?? 0) == 0) {
                    Schema::table($table, function (Blueprint $t) use ($columns, $indexName) {
                        $t->index($columns, $indexName);
                    });
                    echo "âœ… Created index '{$indexName}' on {$table} (" . implode(', ', $columns) . ").\n";
                } else {
                    echo "â„¹ï¸  Index '{$indexName}' already exists â€” skipping add.\n";
                }
            } catch (\Throwable $e) {
                echo "âš ï¸  Skipping add '{$indexName}' â€” error: {$e->getMessage()}\n";
            }
        }

        // Add unique composite key if missing
        try {
            $uniqueExists = DB::selectOne("
                SELECT COUNT(*) AS cnt
                FROM information_schema.TABLE_CONSTRAINTS
                WHERE TABLE_SCHEMA = DATABASE()
                  AND TABLE_NAME = ?
                  AND CONSTRAINT_TYPE = 'UNIQUE'
                  AND CONSTRAINT_NAME = 'unique_ticker_t_resolution'
            ", [$table]);

            if (($uniqueExists->cnt ?? 0) == 0) {
                Schema::table($table, function (Blueprint $t) {
                    $t->unique(['ticker', 't', 'resolution'], 'unique_ticker_t_resolution');
                });
                echo "âœ… Created unique key 'unique_ticker_t_resolution' on {$table} (ticker, t, resolution).\n";
            } else {
                echo "â„¹ï¸  Unique key 'unique_ticker_t_resolution' already exists â€” skipping add.\n";
            }
        } catch (\Throwable $e) {
            echo "âš ï¸  Skipping unique key creation â€” error: {$e->getMessage()}\n";
        }

        // Create or replace view for latest ticker prices
        try {
            DB::statement("
                CREATE OR REPLACE VIEW {$view} AS
                SELECT tph.*
                FROM {$table} tph
                INNER JOIN (
                    SELECT ticker, MAX(t) AS latest_t
                    FROM {$table}
                    GROUP BY ticker
                ) latest
                ON tph.ticker = latest.ticker AND tph.t = latest.latest_t
            ");
            echo "âœ… Created or replaced view '{$view}'.\n";
        } catch (\Throwable $e) {
            echo "âš ï¸  Skipping view creation â€” error: {$e->getMessage()}\n";
        }
    }

    public function down(): void
    {
        $table = 'ticker_price_histories';
        $view = 'latest_ticker_prices';

        if (!Schema::hasTable($table)) {
            echo "âš ï¸  Skipping down(): '{$table}' table not found.\n";
            return;
        }

        $indexes = [
            'ticker_t_index',
            'ticker_resolution_index',
            't_index',
            'unique_ticker_t_resolution',
        ];

        foreach ($indexes as $indexName) {
            try {
                $exists = DB::selectOne("
                    SELECT COUNT(*) AS cnt
                    FROM information_schema.STATISTICS
                    WHERE TABLE_SCHEMA = DATABASE()
                      AND TABLE_NAME = ?
                      AND INDEX_NAME = ?
                ", [$table, $indexName]);

                if (($exists->cnt ?? 0) > 0) {
                    DB::statement("ALTER TABLE {$table} DROP INDEX {$indexName};");
                    echo "âœ… Dropped index '{$indexName}' from {$table}.\n";
                } else {
                    echo "âš ï¸  Skipping drop â€” index '{$indexName}' not found.\n";
                }
            } catch (\Throwable $e) {
                echo "âš ï¸  Skipping drop '{$indexName}' â€” error: {$e->getMessage()}\n";
            }
        }

        // Drop the view if it exists
        try {
            DB::statement("DROP VIEW IF EXISTS {$view};");
            echo "âœ… Dropped view '{$view}'.\n";
        } catch (\Throwable $e) {
            echo "âš ï¸  Skipping view drop â€” error: {$e->getMessage()}\n";
        }
    }
};

===== FILE: database/migrations/2025_10_26_025540_add_latest_price_index_to_ticker_price_histories_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

/**
 * ============================================================================
 *  Migration: add_latest_price_index_to_ticker_price_histories_table
 * ============================================================================
 *
 * ðŸ”§ Purpose:
 *   Adds a compound index (`idx_ticker_latest`) on (ticker, t) to accelerate
 *   lookups for the latest price history per ticker.
 *
 * ðŸ§  Context:
 *   â€¢ Originally created using Schema::table() directly.
 *   â€¢ That version failed under `migrate:refresh` when the index didnâ€™t exist.
 *   â€¢ This version is idempotent â€” it safely checks for the index and table
 *     before modifying, and never throws if itâ€™s missing.
 *
 * âœ… Safe for:
 *   â€¢ `php artisan migrate:refresh`
 *   â€¢ `php artisan migrate:fresh`
 *   â€¢ CI/CD environment setup
 * ============================================================================
 */
return new class extends Migration
{
    /**
     * Apply the migration.
     */
    public function up(): void
    {
        $table = 'ticker_price_histories';
        $indexName = 'idx_ticker_latest';

        // Skip entirely if the table doesn't exist yet
        if (!Schema::hasTable($table)) {
            echo "âš ï¸  Skipping up(): '{$table}' table not found.\n";
            return;
        }

        try {
            // Check if index already exists (safe across MariaDB/MySQL)
            $exists = DB::selectOne("
                SELECT COUNT(*) AS cnt
                FROM information_schema.STATISTICS
                WHERE TABLE_SCHEMA = DATABASE()
                  AND TABLE_NAME = ?
                  AND INDEX_NAME = ?
            ", [$table, $indexName]);

            if (($exists->cnt ?? 0) == 0) {
                // Add index only if missing
                Schema::table($table, function (Blueprint $t) use ($indexName) {
                    $t->index(['ticker', 't'], $indexName);
                });
                echo "âœ… Created index '{$indexName}' on {$table}.\n";
            } else {
                echo "â„¹ï¸  Index '{$indexName}' already exists â€” skipping add.\n";
            }
        } catch (\Throwable $e) {
            echo "âš ï¸  Index creation skipped â€” error: {$e->getMessage()}\n";
        }
    }

    /**
     * Reverse the migration.
     */
    public function down(): void
    {
        $table = 'ticker_price_histories';
        $indexName = 'idx_ticker_latest';

        if (!Schema::hasTable($table)) {
            echo "âš ï¸  Skipping down(): '{$table}' table not found.\n";
            return;
        }

        try {
            // Check if index exists before dropping
            $exists = DB::selectOne("
                SELECT COUNT(*) AS cnt
                FROM information_schema.STATISTICS
                WHERE TABLE_SCHEMA = DATABASE()
                  AND TABLE_NAME = ?
                  AND INDEX_NAME = ?
            ", [$table, $indexName]);

            if (($exists->cnt ?? 0) > 0) {
                DB::statement("ALTER TABLE {$table} DROP INDEX {$indexName};");
                echo "âœ… Dropped index '{$indexName}' from {$table}.\n";
            } else {
                echo "âš ï¸  Skipping drop â€” index '{$indexName}' not found.\n";
            }
        } catch (\Throwable $e) {
            echo "âš ï¸  Skipping drop â€” error: {$e->getMessage()}\n";
        }
    }
};


===== FILE: database/migrations/2025_10_26_032603_partition_ticker_price_histories_final_fix.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;

/**
 * ============================================================================
 *  Migration: partition_ticker_price_histories_final_fix
 * ============================================================================
 *
 * ðŸ”§ Purpose:
 *   Ensures `ticker_price_histories` table is partitioned by `year`,
 *   and gracefully handles all edge cases for rollback or refresh.
 *
 * âœ… This version:
 *   â€¢ Avoids using Schema::table() for dropping missing columns.
 *   â€¢ Uses direct SQL with try/catch for total safety.
 *   â€¢ No assumptions about partition state or year existence.
 *   â€¢ 100% safe for `php artisan migrate:refresh` or `migrate:fresh`.
 * ============================================================================
 */
return new class extends Migration
{
    public function up(): void
    {
        if (!Schema::hasTable('ticker_price_histories')) {
            echo "âš ï¸  Skipping up(): 'ticker_price_histories' table not found.\n";
            return;
        }

        // Ensure `year` column exists
        if (!Schema::hasColumn('ticker_price_histories', 'year')) {
            Schema::table('ticker_price_histories', function ($table) {
                $table->unsignedSmallInteger('year')->nullable()->after('t');
            });

            DB::statement("UPDATE ticker_price_histories SET year = YEAR(t)");
            Schema::table('ticker_price_histories', function ($table) {
                $table->unsignedSmallInteger('year')->nullable(false)->change();
            });

            echo "âœ… Added and populated 'year' column in ticker_price_histories.\n";
        } else {
            echo "â„¹ï¸  'year' column already exists â€” skipping add.\n";
        }

        // Apply partitioning safely
        try {
            DB::statement("
                ALTER TABLE ticker_price_histories
                PARTITION BY RANGE (year) (
                    PARTITION p2020 VALUES LESS THAN (2021),
                    PARTITION p2021 VALUES LESS THAN (2022),
                    PARTITION p2022 VALUES LESS THAN (2023),
                    PARTITION p2023 VALUES LESS THAN (2024),
                    PARTITION p2024 VALUES LESS THAN (2025),
                    PARTITION p2025 VALUES LESS THAN (2026),
                    PARTITION pmax  VALUES LESS THAN MAXVALUE
                );
            ");
            echo "âœ… Applied partitioning to ticker_price_histories.\n";
        } catch (\Throwable $e) {
            echo "âš ï¸  Partitioning step skipped or failed: {$e->getMessage()}\n";
        }
    }

    public function down(): void
    {
        if (!Schema::hasTable('ticker_price_histories')) {
            echo "âš ï¸  Skipping down(): 'ticker_price_histories' table not found.\n";
            return;
        }

        // Safely remove partitioning
        try {
            DB::statement("ALTER TABLE ticker_price_histories REMOVE PARTITIONING;");
            echo "âœ… Partitioning removed from ticker_price_histories.\n";
        } catch (\Throwable $e) {
            echo "âš ï¸  Partition removal skipped: {$e->getMessage()}\n";
        }

        // Safely drop `year` column (manual SQL to avoid Schema cache issues)
        try {
            $columnExists = DB::selectOne("
                SELECT COUNT(*) AS cnt
                FROM information_schema.COLUMNS
                WHERE TABLE_SCHEMA = DATABASE()
                  AND TABLE_NAME = 'ticker_price_histories'
                  AND COLUMN_NAME = 'year'
            ")->cnt ?? 0;

            if ($columnExists > 0) {
                DB::statement("ALTER TABLE ticker_price_histories DROP COLUMN year;");
                echo "âœ… Dropped 'year' column from ticker_price_histories.\n";
            } else {
                echo "âš ï¸  Skipping drop â€” 'year' column not found.\n";
            }
        } catch (\Throwable $e) {
            echo "âš ï¸  Skipping drop â€” error: {$e->getMessage()}\n";
        }
    }
};

===== FILE: database/migrations/2025_10_26_054457_add_vw_to_ticker_price_histories_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('ticker_price_histories', function (Blueprint $table) {
            $table->decimal('vw', 12, 6)->nullable()->after('v');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('ticker_price_histories', function (Blueprint $table) {
            $table->dropColumn('vw');
        });
    }
};


===== FILE: database/migrations/2025_10_26_055453_safely_remove_ticker_column_from_ticker_price_histories_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

/**
 * ============================================================================
 *  Migration: safely_remove_ticker_column_from_ticker_price_histories_table
 * ============================================================================
 *
 * ðŸ”§ Purpose:
 *   Removes the legacy `ticker` column and its associated indexes from the
 *   `ticker_price_histories` table. This was previously used for symbol strings
 *   (e.g., "AAPL") before normalization to `ticker_id`.
 *
 * ðŸ§  Refresh-Safe Features:
 *   â€¢ Checks for table and column existence before altering.
 *   â€¢ Verifies each index before attempting to drop.
 *   â€¢ Emits detailed CLI messages for clarity during migrations.
 *   â€¢ Restores column + index safely in `down()`.
 * ============================================================================
 */
return new class extends Migration
{
    public function up(): void
    {
        $table = 'ticker_price_histories';
        $column = 'ticker';
        $indexes = [
            'unique_ticker_t_resolution_year',
            'ticker_t_index',
            'ticker_resolution_index',
            'ticker_price_histories_ticker_index',
            'idx_ticker_latest',
        ];

        if (!Schema::hasTable($table)) {
            echo "âš ï¸  Skipping up(): '{$table}' table not found.\n";
            return;
        }

        // 1ï¸âƒ£ Drop indexes referencing the ticker column
        foreach ($indexes as $index) {
            try {
                $exists = DB::selectOne("
                    SELECT COUNT(*) AS cnt
                    FROM information_schema.STATISTICS
                    WHERE TABLE_SCHEMA = DATABASE()
                      AND TABLE_NAME = ?
                      AND INDEX_NAME = ?
                ", [$table, $index]);

                if (($exists->cnt ?? 0) > 0) {
                    DB::statement("ALTER TABLE {$table} DROP INDEX `{$index}`;");
                    echo "âœ… Dropped index '{$index}' from {$table}.\n";
                } else {
                    echo "âš ï¸  Skipping drop â€” index '{$index}' not found.\n";
                }
            } catch (\Throwable $e) {
                echo "âš ï¸  Could not drop index '{$index}': {$e->getMessage()}\n";
            }
        }

        // 2ï¸âƒ£ Drop the legacy `ticker` column if it exists
        if (Schema::hasColumn($table, $column)) {
            try {
                Schema::table($table, function (Blueprint $t) use ($column) {
                    $t->dropColumn($column);
                });
                echo "âœ… Dropped column '{$column}' from {$table}.\n";
            } catch (\Throwable $e) {
                echo "âš ï¸  Skipping column drop â€” error: {$e->getMessage()}\n";
            }
        } else {
            echo "â„¹ï¸  Column '{$column}' already absent â€” skipping drop.\n";
        }
    }

    public function down(): void
    {
        $table = 'ticker_price_histories';
        $column = 'ticker';

        if (!Schema::hasTable($table)) {
            echo "âš ï¸  Skipping down(): '{$table}' table not found.\n";
            return;
        }

        // 1ï¸âƒ£ Restore column if missing
        if (!Schema::hasColumn($table, $column)) {
            Schema::table($table, function (Blueprint $t) use ($column) {
                $t->string($column, 16)->nullable()->after('ticker_id');
            });
            echo "âœ… Restored column '{$column}' to {$table}.\n";
        } else {
            echo "â„¹ï¸  Column '{$column}' already exists â€” skipping restore.\n";
        }

        // 2ï¸âƒ£ Optionally restore an index for backward compatibility
        try {
            $exists = DB::selectOne("
                SELECT COUNT(*) AS cnt
                FROM information_schema.STATISTICS
                WHERE TABLE_SCHEMA = DATABASE()
                  AND TABLE_NAME = ?
                  AND COLUMN_NAME = ?
            ", [$table, $column]);

            if (($exists->cnt ?? 0) == 0) {
                Schema::table($table, function (Blueprint $t) use ($column) {
                    $t->index($column, 'ticker_price_histories_ticker_index');
                });
                echo "âœ… Restored index 'ticker_price_histories_ticker_index' on '{$column}'.\n";
            } else {
                echo "â„¹ï¸  Index already exists for '{$column}' â€” skipping restore.\n";
            }
        } catch (\Throwable $e) {
            echo "âš ï¸  Could not restore index for '{$column}': {$e->getMessage()}\n";
        }
    }
};

===== FILE: database/migrations/2025_10_26_180113_add_timestamps_to_job_batches_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

/**
 * ============================================================================
 *  Migration: add_timestamps_to_job_batches_table
 * ============================================================================
 *
 * ðŸ”§ Purpose:
 *   Adds standard `created_at` and `updated_at` timestamps to the
 *   `job_batches` table if they don't already exist.
 *
 * ðŸ’¡ Context:
 *   This migration may fail during `migrate:refresh` if `job_batches`
 *   has already been dropped or rebuilt by later migrations.
 *
 * âœ… Improvements:
 *   â€¢ Checks for table existence before altering.
 *   â€¢ Adds missing columns only if not present.
 *   â€¢ Skips gracefully (with console output) if table/columns missing.
 *   â€¢ CI-safe, idempotent, and rollback-safe.
 * ============================================================================
 */
return new class extends Migration
{
    /**
     * Apply migration â€” add timestamps to job_batches.
     */
    public function up(): void
    {
        if (!Schema::hasTable('job_batches')) {
            echo "âš ï¸  Skipping up(): 'job_batches' table not found.\n";
            return;
        }

        Schema::table('job_batches', function (Blueprint $table) {
            if (!Schema::hasColumn('job_batches', 'created_at')) {
                $table->timestamp('created_at')->nullable();
            }
            if (!Schema::hasColumn('job_batches', 'updated_at')) {
                $table->timestamp('updated_at')->nullable();
            }
        });

        echo "âœ… job_batches timestamps added (if missing).\n";
    }

    /**
     * Rollback migration â€” drop the added timestamp columns.
     */
    public function down(): void
    {
        if (!Schema::hasTable('job_batches')) {
            echo "âš ï¸  Skipping down(): 'job_batches' table not found.\n";
            return;
        }

        Schema::table('job_batches', function (Blueprint $table) {
            if (Schema::hasColumn('job_batches', 'created_at')) {
                $table->dropColumn('created_at');
            }
            if (Schema::hasColumn('job_batches', 'updated_at')) {
                $table->dropColumn('updated_at');
            }
        });

        echo "âœ… job_batches timestamps dropped (if existed).\n";
    }
};

===== FILE: database/migrations/2025_10_26_180545_fix_timestamps_in_job_batches_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

/**
 * ============================================================================
 *  Migration: fix_timestamps_in_job_batches_table
 * ============================================================================
 *
 * ðŸ”§ Purpose:
 *   Converts `created_at` and `updated_at` columns in `job_batches`
 *   between DATETIME and TIMESTAMP for consistent schema alignment.
 *
 * ðŸ’¡ Context:
 *   During `migrate:refresh`, this table may already be dropped or rebuilt
 *   by later migrations (e.g., `rebuild_job_batches_table`), causing
 *   SQLSTATE[42S02] errors if not checked.
 *
 * âœ… Improvements:
 *   â€¢ Verifies table existence before altering.
 *   â€¢ Skips missing columns gracefully.
 *   â€¢ Provides clear console output for visibility.
 *   â€¢ Fully idempotent and refresh-safe for CI/CD pipelines.
 * ============================================================================
 */
return new class extends Migration
{
    /**
     * Apply migration â€” convert TIMESTAMP â†’ DATETIME.
     */
    public function up(): void
    {
        if (!Schema::hasTable('job_batches')) {
            echo "âš ï¸  Skipping up(): 'job_batches' table not found.\n";
            return;
        }

        $columns = Schema::getColumnListing('job_batches');

        Schema::table('job_batches', function (Blueprint $table) use ($columns) {
            if (in_array('created_at', $columns)) {
                DB::statement('ALTER TABLE job_batches MODIFY created_at DATETIME NULL');
            }
            if (in_array('updated_at', $columns)) {
                DB::statement('ALTER TABLE job_batches MODIFY updated_at DATETIME NULL');
            }
        });

        echo "âœ… job_batches columns converted to DATETIME (if existed).\n";
    }

    /**
     * Rollback migration â€” convert DATETIME â†’ TIMESTAMP.
     */
    public function down(): void
    {
        if (!Schema::hasTable('job_batches')) {
            echo "âš ï¸  Skipping down(): 'job_batches' table not found.\n";
            return;
        }

        $columns = Schema::getColumnListing('job_batches');

        Schema::table('job_batches', function (Blueprint $table) use ($columns) {
            if (in_array('created_at', $columns)) {
                DB::statement('ALTER TABLE job_batches MODIFY created_at TIMESTAMP NULL');
            }
            if (in_array('updated_at', $columns)) {
                DB::statement('ALTER TABLE job_batches MODIFY updated_at TIMESTAMP NULL');
            }
        });

        echo "âœ… job_batches columns reverted to TIMESTAMP (if existed).\n";
    }
};


===== FILE: database/migrations/2025_10_26_181650_fix_job_batches_datetime_columns.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

/**
 * ============================================================================
 *  Migration: fix_job_batches_datetime_columns
 * ============================================================================
 *
 * ðŸ”§ Purpose:
 *   Converts integer timestamp fields in `job_batches` to proper DATETIME columns.
 *
 * ðŸ§  Context:
 *   This migration originally assumed the table always existed. However, during
 *   full refreshes or rebuild sequences, `job_batches` may already be dropped or
 *   recreated â€” causing SQLSTATE[42S02] ("table not found") errors.
 *
 * âœ… Improvements:
 *   â€¢ Checks if table exists before altering.
 *   â€¢ Skips missing columns gracefully.
 *   â€¢ Outputs clear progress messages for local devs.
 *   â€¢ Fully idempotent and CI-safe.
 * ============================================================================
 */
return new class extends Migration
{
    /**
     * Apply migration â€” convert int timestamps â†’ datetime.
     */
    public function up(): void
    {
        if (!Schema::hasTable('job_batches')) {
            echo "âš ï¸  Skipping up(): 'job_batches' table not found.\n";
            return;
        }

        Schema::table('job_batches', function (Blueprint $table) {
            $columns = Schema::getColumnListing('job_batches');

            if (in_array('created_at', $columns)) {
                DB::statement('ALTER TABLE job_batches MODIFY created_at DATETIME NULL');
            }
            if (in_array('finished_at', $columns)) {
                DB::statement('ALTER TABLE job_batches MODIFY finished_at DATETIME NULL');
            }
            if (in_array('cancelled_at', $columns)) {
                DB::statement('ALTER TABLE job_batches MODIFY cancelled_at DATETIME NULL');
            }
        });

        echo "âœ… job_batches datetime columns adjusted.\n";
    }

    /**
     * Rollback migration â€” revert datetime â†’ integer timestamps.
     */
    public function down(): void
    {
        if (!Schema::hasTable('job_batches')) {
            echo "âš ï¸  Skipping down(): 'job_batches' table not found.\n";
            return;
        }

        Schema::table('job_batches', function (Blueprint $table) {
            $columns = Schema::getColumnListing('job_batches');

            if (in_array('created_at', $columns)) {
                DB::statement('ALTER TABLE job_batches MODIFY created_at BIGINT NULL');
            }
            if (in_array('finished_at', $columns)) {
                DB::statement('ALTER TABLE job_batches MODIFY finished_at BIGINT NULL');
            }
            if (in_array('cancelled_at', $columns)) {
                DB::statement('ALTER TABLE job_batches MODIFY cancelled_at BIGINT NULL');
            }
        });

        echo "âœ… job_batches column rollback complete.\n";
    }
};

===== FILE: database/migrations/2025_10_28_161045_add_author_and_enhanced_fields_to_ticker_news_items_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('ticker_news_items', function (Blueprint $table) {
            // --- Rename existing column for consistency ---
            if (Schema::hasColumn('ticker_news_items', 'source')) {
                $table->renameColumn('source', 'publisher_name');
            }

            // --- New structured Polygon.io fields ---
            $table->string('article_id', 128)->nullable()->after('id')->index();
            $table->string('author', 255)->nullable()->after('publisher_name');
            $table->string('image_url', 512)->nullable()->after('summary');
            $table->string('amp_url', 512)->nullable()->after('image_url');

            // Publisher details (beyond name)
            $table->string('publisher_logo_url', 512)->nullable()->after('author');
            $table->string('publisher_favicon_url', 512)->nullable()->after('publisher_logo_url');
            $table->string('publisher_homepage_url', 512)->nullable()->after('publisher_favicon_url');

            // Related tickers, keywords, and insights
            $table->json('tickers_list')->nullable()->after('publisher_homepage_url');
            $table->json('keywords')->nullable()->after('tickers_list');
            $table->json('insights')->nullable()->after('keywords');

            // Flattened insight fields for direct filtering
            $table->string('insight_sentiment', 32)->nullable()->after('insights');
            $table->text('insight_reasoning')->nullable()->after('insight_sentiment');
            $table->string('insight_ticker', 16)->nullable()->after('insight_reasoning');

            // Rename published_at â†’ published_utc for consistency
            if (Schema::hasColumn('ticker_news_items', 'published_at')) {
                $table->renameColumn('published_at', 'published_utc');
            }
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('ticker_news_items', function (Blueprint $table) {
            // Drop new fields
            $table->dropColumn([
                'article_id',
                'author',
                'image_url',
                'amp_url',
                'publisher_logo_url',
                'publisher_favicon_url',
                'publisher_homepage_url',
                'tickers_list',
                'keywords',
                'insights',
                'insight_sentiment',
                'insight_reasoning',
                'insight_ticker',
            ]);

            // Rename back to original
            if (Schema::hasColumn('ticker_news_items', 'publisher_name')) {
                $table->renameColumn('publisher_name', 'source');
            }

            if (Schema::hasColumn('ticker_news_items', 'published_utc')) {
                $table->renameColumn('published_utc', 'published_at');
            }
        });
    }
};

===== FILE: database/migrations/2025_10_28_230455_create_ticker_fundamentals_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {

    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('ticker_fundamentals', function (Blueprint $table) {
            $table->id();
            $table->foreignId('ticker_id')->nullable()->index();
            $table->foreign('ticker_id', 'fk_tfundamentals_ticker_id')->references('id')->on('tickers')->nullOnDelete();
            $table->string('ticker', 16)->index();
            $table->string('cik', 32)->nullable()->index();
            $table->string('company_name')->nullable();

            $table->string('fiscal_period', 8)->nullable()->index(); // e.g., Q1, Q2, FY
            $table->string('fiscal_year', 8)->nullable()->index();
            $table->string('timeframe', 16)->nullable()->index(); // e.g., quarterly, annual
            $table->string('status', 16)->nullable()->index();

            $table->date('start_date')->nullable()->index();
            $table->date('end_date')->nullable()->index();
            $table->date('filing_date')->nullable()->index();

            $table->string('source_filing_url', 512)->nullable();
            $table->string('source_filing_file_url', 512)->nullable();

            // Core top-level metrics for quick access
            $table->decimal('total_assets', 24, 2)->nullable();
            $table->decimal('total_liabilities', 24, 2)->nullable();
            $table->decimal('equity', 24, 2)->nullable();
            $table->decimal('net_income', 24, 2)->nullable();
            $table->decimal('revenue', 24, 2)->nullable();
            $table->decimal('operating_income', 24, 2)->nullable();
            $table->decimal('gross_profit', 24, 2)->nullable();
            $table->decimal('eps_basic', 16, 4)->nullable();
            $table->decimal('eps_diluted', 16, 4)->nullable();

            // Raw JSON blobs
            $table->json('balance_sheet')->nullable();
            $table->json('income_statement')->nullable();
            $table->json('cash_flow_statement')->nullable();
            $table->json('comprehensive_income')->nullable();
            $table->json('raw')->nullable();

            $table->timestamp('fetched_at')->nullable();
            $table->timestamps();

            $table->unique(['ticker_id', 'fiscal_year', 'fiscal_period'], 'uq_tfundamentals_unique_period');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('ticker_fundamentals');
    }
};


===== FILE: database/migrations/2025_10_28_230558_create_ticker_fundamentals_financials_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('ticker_fundamentals_financials', function (Blueprint $table) {
            $table->id();

            // Foreign key to tickers
            $table->foreignId('ticker_id')->nullable()->index();
            $table->foreign('ticker_id', 'fk_tfundamentals_financials_ticker_id')
                  ->references('id')
                  ->on('tickers')
                  ->nullOnDelete();

            // Core identifying fields
            $table->string('ticker', 16)->index();
            $table->string('fiscal_period', 8)->nullable()->index(); // Q1, Q2, FY, etc.
            $table->string('fiscal_year', 8)->nullable()->index();
            $table->date('start_date')->nullable();
            $table->date('end_date')->nullable();
            $table->date('filing_date')->nullable();

            // Financial summary metrics
            $table->decimal('assets', 24, 2)->nullable();
            $table->decimal('liabilities', 24, 2)->nullable();
            $table->decimal('equity', 24, 2)->nullable();
            $table->decimal('revenues', 24, 2)->nullable();
            $table->decimal('net_income', 24, 2)->nullable();
            $table->decimal('gross_profit', 24, 2)->nullable();
            $table->decimal('operating_income', 24, 2)->nullable();
            $table->decimal('eps_basic', 16, 4)->nullable();
            $table->decimal('eps_diluted', 16, 4)->nullable();

            // Full JSON statements for detailed analytics
            $table->json('balance_sheet')->nullable();
            $table->json('income_statement')->nullable();
            $table->json('cash_flow_statement')->nullable();
            $table->json('comprehensive_income')->nullable();

            // Raw payload for traceability
            $table->json('raw')->nullable();

            // Timestamp from Polygon response and local ingestion tracking
            $table->timestamp('fetched_at')->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('ticker_fundamentals_financials');
    }
};

===== FILE: database/migrations/2025_10_29_061652_extend_ticker_fundamentals_financials_for_metrics.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {

    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('ticker_fundamentals_financials', function (Blueprint $table) {
            if (!Schema::hasColumn('ticker_fundamentals_financials', 'statement')) {
                $table->string('statement', 64)->nullable()->after('ticker');
            }
            if (!Schema::hasColumn('ticker_fundamentals_financials', 'line_item')) {
                $table->string('line_item', 128)->nullable()->after('statement');
            }
            if (!Schema::hasColumn('ticker_fundamentals_financials', 'label')) {
                $table->string('label')->nullable()->after('line_item');
            }
            if (!Schema::hasColumn('ticker_fundamentals_financials', 'unit')) {
                $table->string('unit')->nullable()->after('label');
            }
            if (!Schema::hasColumn('ticker_fundamentals_financials', 'display_order')) {
                $table->integer('display_order')->nullable()->after('unit');
            }
            if (!Schema::hasColumn('ticker_fundamentals_financials', 'value')) {
                $table->decimal('value', 24, 4)->nullable()->after('display_order');
            }
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('ticker_fundamentals_financials', function (Blueprint $table) {
            foreach (['statement','line_item','label','unit','display_order','value'] as $col) {
                if (Schema::hasColumn('ticker_fundamentals_financials', $col)) {
                    $table->dropColumn($col);
                }
            }
        });
    }
};


===== FILE: database/migrations/2025_10_29_062011_add_fundamental_id_to_ticker_fundamentals_financials.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;

/**
 * ============================================================================
 *  Migration: Add fundamental_id to ticker_fundamentals_financials (early version)
 * ============================================================================
 *
 * ðŸ”§ Purpose:
 *   Introduced an initial `fundamental_id` column linking financials â†’ fundamentals.
 *   This version now mirrors the hardened version used in the later migration
 *   to ensure full rollback compatibility and no SQLSTATE 1091/1072 errors.
 *
 * ============================================================================
 */
return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        $table = 'ticker_fundamentals_financials';
        $column = 'fundamental_id';

        if (!Schema::hasColumn($table, $column)) {
            Schema::table($table, function (Blueprint $table) {
                $table->unsignedBigInteger('fundamental_id')->nullable()->after('id');

                if (Schema::hasTable('ticker_fundamentals')) {
                    $table->foreign('fundamental_id')
                          ->references('id')
                          ->on('ticker_fundamentals')
                          ->onDelete('cascade');
                }
            });
        }
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        $table = 'ticker_fundamentals_financials';
        $column = 'fundamental_id';

        // --- Verify existence directly through information_schema ---
        $colExists = DB::table('information_schema.COLUMNS')
            ->where('TABLE_SCHEMA', DB::raw('DATABASE()'))
            ->where('TABLE_NAME', $table)
            ->where('COLUMN_NAME', $column)
            ->exists();

        if (!$colExists) {
            echo "âœ… Skipping rollback â€” column '{$column}' not found in {$table}.\n";
            return;
        }

        // --- Drop FK constraints referencing this column (if any) ---
        $constraints = DB::select("
            SELECT CONSTRAINT_NAME
            FROM information_schema.KEY_COLUMN_USAGE
            WHERE TABLE_SCHEMA = DATABASE()
              AND TABLE_NAME = ?
              AND COLUMN_NAME = ?
              AND REFERENCED_TABLE_NAME IS NOT NULL
        ", [$table, $column]);

        foreach ($constraints as $fk) {
            $fkName = $fk->CONSTRAINT_NAME;
            echo "ðŸ§¹ Dropping FK constraint '{$fkName}' on {$table}...\n";
            try {
                DB::statement("ALTER TABLE `{$table}` DROP FOREIGN KEY `{$fkName}`");
            } catch (\Throwable $e) {
                echo "âš ï¸  Could not drop FK '{$fkName}': {$e->getMessage()}\n";
            }
        }

        // --- Drop the column safely ---
        try {
            DB::statement("ALTER TABLE `{$table}` DROP COLUMN `{$column}`");
            echo "âœ… Column '{$column}' dropped from {$table}.\n";
        } catch (\Throwable $e) {
            echo "âš ï¸  Column drop skipped: {$e->getMessage()}\n";
        }
    }
};


===== FILE: database/migrations/2025_10_29_063912_cleanup_ticker_fundamentals_financials_columns.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('ticker_fundamentals_financials', function (Blueprint $table) {
            // Drop redundant high-level summary and JSON columns
            $dropColumns = [
                'assets', 'liabilities', 'equity', 'revenues', 'net_income',
                'gross_profit', 'operating_income', 'eps_basic', 'eps_diluted',
                'balance_sheet', 'income_statement', 'cash_flow_statement',
                'comprehensive_income', 'raw', 'fetched_at', 'filing_date',
                'start_date'
            ];

            foreach ($dropColumns as $col) {
                if (Schema::hasColumn('ticker_fundamentals_financials', $col)) {
                    $table->dropColumn($col);
                }
            }
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('ticker_fundamentals_financials', function (Blueprint $table) {
            // Recreate dropped columns (basic structure only)
            $table->decimal('assets', 24, 2)->nullable();
            $table->decimal('liabilities', 24, 2)->nullable();
            $table->decimal('equity', 24, 2)->nullable();
            $table->decimal('revenues', 24, 2)->nullable();
            $table->decimal('net_income', 24, 2)->nullable();
            $table->decimal('gross_profit', 24, 2)->nullable();
            $table->decimal('operating_income', 24, 2)->nullable();
            $table->decimal('eps_basic', 16, 4)->nullable();
            $table->decimal('eps_diluted', 16, 4)->nullable();
            $table->longText('balance_sheet')->nullable();
            $table->longText('income_statement')->nullable();
            $table->longText('cash_flow_statement')->nullable();
            $table->longText('comprehensive_income')->nullable();
            $table->longText('raw')->nullable();
            $table->timestamp('fetched_at')->nullable();
            $table->date('filing_date')->nullable();
            $table->date('start_date')->nullable();
        });
    }
};

===== FILE: database/migrations/2025_10_29_064334_add_indexes_to_ticker_fundamentals_financials.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::table('ticker_fundamentals_financials', function (Blueprint $table) {
            // Add optimized indexes for high-speed analytics
            $table->index(['ticker_id', 'end_date'], 'tff_ticker_end_date_index');
            $table->index(['fiscal_year', 'fiscal_period'], 'tff_fiscal_index');
            $table->index(['statement', 'line_item'], 'tff_statement_line_item_index');
            $table->index(['ticker', 'statement'], 'tff_ticker_statement_index');
        });
    }

    public function down(): void
    {
        Schema::table('ticker_fundamentals_financials', function (Blueprint $table) {
            $table->dropIndex('tff_ticker_end_date_index');
            $table->dropIndex('tff_fiscal_index');
            $table->dropIndex('tff_statement_line_item_index');
            $table->dropIndex('tff_ticker_statement_index');
        });
    }
};

===== FILE: database/migrations/2025_10_29_064557_add_unique_constraint_to_ticker_fundamentals_financials.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('ticker_fundamentals_financials', function (Blueprint $table) {
            $table->unique(['fundamental_id', 'line_item'], 'tff_fundamental_line_item_unique');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('ticker_fundamentals_financials', function (Blueprint $table) {
            $table->dropUnique('tff_fundamental_line_item_unique');
        });
    }
};


===== FILE: database/migrations/2025_10_29_231407_add_display_order_to_ticker_fundamentals_financials_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {

    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('ticker_fundamentals_financials', function (Blueprint $table) {
            if (!Schema::hasColumn('ticker_fundamentals_financials', 'display_order')) {
                $table->integer('display_order')->nullable()->after('id')->index();
            }
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('ticker_fundamentals_financials', function (Blueprint $table) {
            if (Schema::hasColumn('ticker_fundamentals_financials', 'display_order')) {
                $table->dropColumn('display_order');
            }
        });
    }
};


===== FILE: database/migrations/2025_10_29_231550_add_fundamental_id_to_ticker_fundamentals_financials_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;

/**
 * ============================================================================
 *  Migration: Add fundamental_id to ticker_fundamentals_financials
 * ============================================================================
 *
 * ðŸ”§ Purpose:
 *   Adds a nullable `fundamental_id` column to link financial rows back
 *   to their parent record in `ticker_fundamentals`.
 *
 * ðŸ§© Features:
 *   - Adds column + FK if not present.
 *   - Drops FK + column safely using direct schema checks (no cache).
 *   - Skips gracefully on all dev/CI environments.
 *
 * ============================================================================
 */
return new class extends Migration
{
    public function up(): void
    {
        if (!Schema::hasColumn('ticker_fundamentals_financials', 'fundamental_id')) {
            Schema::table('ticker_fundamentals_financials', function (Blueprint $table) {
                $table->unsignedBigInteger('fundamental_id')->nullable()->after('id');

                if (Schema::hasTable('ticker_fundamentals')) {
                    $table->foreign('fundamental_id')
                          ->references('id')
                          ->on('ticker_fundamentals')
                          ->onDelete('cascade');
                }
            });
        }
    }

    public function down(): void
    {
        $table = 'ticker_fundamentals_financials';
        $column = 'fundamental_id';

        // Check directly via information_schema to avoid Laravel's cache
        $colExists = DB::table('information_schema.COLUMNS')
            ->where('TABLE_SCHEMA', DB::raw('DATABASE()'))
            ->where('TABLE_NAME', $table)
            ->where('COLUMN_NAME', $column)
            ->exists();

        if (!$colExists) {
            echo "âœ… Skipping rollback â€” column '{$column}' not found in {$table}.\n";
            return;
        }

        // Drop FK(s) if present
        $constraints = DB::select("
            SELECT CONSTRAINT_NAME
            FROM information_schema.KEY_COLUMN_USAGE
            WHERE TABLE_SCHEMA = DATABASE()
              AND TABLE_NAME = ?
              AND COLUMN_NAME = ?
              AND REFERENCED_TABLE_NAME IS NOT NULL
        ", [$table, $column]);

        foreach ($constraints as $fk) {
            $fkName = $fk->CONSTRAINT_NAME;
            echo "ðŸ§¹ Dropping FK constraint '{$fkName}' on {$table}...\n";
            try {
                DB::statement("ALTER TABLE `{$table}` DROP FOREIGN KEY `{$fkName}`");
            } catch (\Throwable $e) {
                echo "âš ï¸  Could not drop FK '{$fkName}': {$e->getMessage()}\n";
            }
        }

        // Drop column directly, bypassing Schema cache
        try {
            DB::statement("ALTER TABLE `{$table}` DROP COLUMN `{$column}`");
            echo "âœ… Column '{$column}' dropped from {$table}.\n";
        } catch (\Throwable $e) {
            echo "âš ï¸  Column drop skipped: {$e->getMessage()}\n";
        }
    }
};

===== FILE: database/migrations/2025_10_29_231655_add_unique_period_index_to_ticker_fundamentals_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

return new class extends Migration {

    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('ticker_fundamentals', function (Blueprint $table) {
            $indexName = 'uq_tfundamentals_unique_period';
            
            // Check existing indexes safely
            $existingIndexes = collect(DB::select('SHOW INDEX FROM ticker_fundamentals'))
                ->pluck('Key_name');

            if (!$existingIndexes->contains($indexName)) {
                $table->unique(
                    ['ticker_id', 'fiscal_year', 'fiscal_period'],
                    $indexName
                );
            }
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('ticker_fundamentals', function (Blueprint $table) {
            if (Schema::hasTable('ticker_fundamentals')) {
                $table->dropUnique('uq_tfundamentals_unique_period');
            }
        });
    }
};

===== FILE: database/migrations/2025_10_30_014834_add_composite_index_to_ticker_indicators.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {

    /**
     * Run the migrations.
     */
    public function up(): void
    {
        if (Schema::hasTable('ticker_indicators')) {
            Schema::table('ticker_indicators', function (Blueprint $table) {
                // Speeds: WHERE ticker_id=? AND indicator=? AND t BETWEEN ?
                $table->index(['ticker_id', 'indicator', 't'], 'idx_ticker_indicator_t');
            });
        }
    }

    
    public function down(): void
    {
        if (Schema::hasTable('ticker_indicators')) {
            Schema::table('ticker_indicators', function (Blueprint $table) {
                $table->dropIndex('idx_ticker_indicator_t');
            });
        }
    }
};

===== FILE: database/migrations/2025_10_30_185854_create_ticker_correlations_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {

    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('ticker_correlations', function (Blueprint $table) {
            $table->id();
            $table->unsignedBigInteger('ticker_id_a'); // e.g., AAPL
            $table->unsignedBigInteger('ticker_id_b'); // e.g., NVDA
            $table->date('as_of_date');                 // end of rolling window
            $table->float('corr', 8, 5)->nullable();    // correlation coefficient
            $table->float('beta', 8, 5)->nullable();    // optional regression slope
            $table->float('r2', 8, 5)->nullable();      // optional RÂ²
            $table->timestamps();

            $table->unique(['ticker_id_a', 'ticker_id_b', 'as_of_date']);
            $table->index(['ticker_id_a', 'as_of_date']);
        });
    }

    
    public function down(): void
    {
        Schema::dropIfExists('ticker_correlations');
    }
};


===== FILE: database/migrations/2025_10_30_232901_create_ticker_feature_snapshots_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     *
     * Creates the `ticker_feature_snapshots` table, which stores a per-ticker,
     * per-date JSON blob of all computed indicators and derived analytics.
     *
     * This structure serves as a compact, AI-ready "feature vector" format
     * â€” one record per ticker per day â€” optimized for machine learning and
     * market modeling pipelines.
     */
    public function up(): void
    {
        Schema::create('ticker_feature_snapshots', function (Blueprint $table) {
            $table->id();

            // The ticker symbol reference
            $table->foreignId('ticker_id')->constrained()->cascadeOnDelete();

            // Timestamp (typically 1D resolution)
            $table->date('t')->index();

            // All computed indicators and analytics as JSON
            $table->json('indicators');

            // Optional embedding vector or summary fields for LLM ingestion
            $table->json('embedding')->nullable();

            $table->timestamps();

            // Each ticker_id + date combination must be unique
            $table->unique(['ticker_id', 't']);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('ticker_feature_snapshots');
    }
};

===== FILE: database/migrations/2025_10_31_050715_alter_ticker_feature_snapshots_add_indicators_column.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        if (!Schema::hasTable('ticker_feature_snapshots')) {
            return;
        }

        Schema::table('ticker_feature_snapshots', function (Blueprint $table) {
            if (!Schema::hasColumn('ticker_feature_snapshots', 'indicators')) {
                $table->longText('indicators')
                    ->nullable()
                    ->collation('utf8mb4_bin')
                    ->after('t');
            }
        });

        // Add JSON validity check (safe fallback for MariaDB/MySQL)
        try {
            DB::statement("ALTER TABLE `ticker_feature_snapshots`
                ADD CONSTRAINT `chk_tfs_indicators_json`
                CHECK (JSON_VALID(`indicators`))");
        } catch (\Throwable $e) {
            // MariaDB <10.4 or MySQL <5.7 may skip this silently
        }

        // Add composite index if it doesn't already exist
        if (!$this->indexExists('ticker_feature_snapshots', 'idx_tfs_ticker_t')) {
            Schema::table('ticker_feature_snapshots', function (Blueprint $table) {
                $table->index(['ticker_id', 't'], 'idx_tfs_ticker_t');
            });
        }
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        if (!Schema::hasTable('ticker_feature_snapshots')) {
            return;
        }

        Schema::table('ticker_feature_snapshots', function (Blueprint $table) {
            if (Schema::hasColumn('ticker_feature_snapshots', 'indicators')) {
                $table->dropColumn('indicators');
            }
            if ($this->indexExists('ticker_feature_snapshots', 'idx_tfs_ticker_t')) {
                $table->dropIndex('idx_tfs_ticker_t');
            }
        });

        try {
            DB::statement("ALTER TABLE `ticker_feature_snapshots`
                DROP CONSTRAINT `chk_tfs_indicators_json`");
        } catch (\Throwable $e) {
            // Safe to ignore
        }
    }

    /**
     * Cross-DB safe index existence check using SHOW INDEX.
     */
    private function indexExists(string $table, string $index): bool
    {
        try {
            $dbName = DB::getDatabaseName();
            $res = DB::select("
                SELECT COUNT(1) AS found
                FROM information_schema.statistics
                WHERE table_schema = ? AND table_name = ? AND index_name = ?
                LIMIT 1
            ", [$dbName, $table, $index]);

            return isset($res[0]) && (int)$res[0]->found > 0;
        } catch (\Throwable $e) {
            return false;
        }
    }
};

===== FILE: database/migrations/2025_10_31_140525_create_ticker_feature_metrics_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('ticker_feature_metrics', function (Blueprint $table) {
            $table->id();
            $table->foreignId('ticker_id')->constrained('tickers')->onDelete('cascade');
            $table->date('t')->index();

            $table->double('sharpe_60')->nullable();
            $table->double('volatility_30')->nullable();
            $table->double('drawdown')->nullable();
            $table->double('beta_60')->nullable();
            $table->double('momentum_10')->nullable();

            $table->timestamps();

            $table->unique(['ticker_id', 't']);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('ticker_feature_metrics');
    }
};


===== FILE: database/migrations/2025_11_01_085959_create_data_validation_logs_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

/**
 * ============================================================================
 *  CreateDataValidationLogsTable
 * ============================================================================
 *
 * Purpose:
 *   Persistent audit log for data validation runs across TickerWolf.ai subsystems.
 *   Records metadata, counts, and anomaly summaries for each validation event.
 *
 *   This table is intentionally generic â€” the "entity_type" column distinguishes
 *   between ticker-level, sentiment-level, or other data validations.
 *
 * ============================================================================
 */
return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('data_validation_logs', function (Blueprint $table) {
            $table->id();

            // Generic categorization fields
            $table->string('entity_type', 50)->default('ticker')
                  ->comment('The logical entity being validated (e.g. ticker, sentiment, fundamentals)');
            $table->string('command_name', 100)
                  ->comment('The artisan command or script that triggered this validation');

            // Counts and summary metrics
            $table->unsignedInteger('total_entities')->nullable()
                  ->comment('Total count of expected records');
            $table->unsignedInteger('validated_count')->nullable()
                  ->comment('Number of entities successfully validated');
            $table->unsignedInteger('missing_count')->nullable()
                  ->comment('Number of missing or invalid entities');

            // JSON summary blob for flexible anomaly detail storage
            $table->json('details')->nullable()
                  ->comment('JSON-encoded summary of anomalies, missing tables, etc.');

            // Status & timing
            $table->enum('status', ['success', 'warning', 'error'])
                  ->default('success')
                  ->comment('Overall validation outcome');
            $table->timestamp('started_at')->nullable();
            $table->timestamp('completed_at')->nullable();

            // Traceability
            $table->string('initiated_by', 100)->nullable()
                  ->comment('User or system actor initiating validation');
            $table->timestamps();
        });
    }

    
    public function down(): void
    {
        Schema::dropIfExists('data_validation_logs');
    }
};

===== FILE: database/migrations/2025_11_01_092337_widen_columns_in_data_validation_logs.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {

    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('data_validation_logs', function (Blueprint $table) {
            $table->unsignedBigInteger('total_entities')->nullable()->change();
            $table->unsignedBigInteger('validated_count')->nullable()->change();
            $table->unsignedBigInteger('missing_count')->nullable()->change();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('data_validation_logs', function (Blueprint $table) {
            $table->unsignedInteger('total_entities')->nullable()->change();
            $table->unsignedInteger('validated_count')->nullable()->change();
            $table->unsignedInteger('missing_count')->nullable()->change();
        });
    }
};

===== FILE: database/migrations/2025_11_02_021816_add_data_source_health_and_polygon_flags.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

/**
 * ============================================================================
 *  Migration: add_data_source_health_and_polygon_flags
 * ============================================================================
 *
 * ðŸ”§ Purpose:
 *   â€¢ Adds upstream health tracking + Polygon status flags.
 *   â€¢ Enables root-cause analysis for missing data (local vs. upstream).
 *
 * ðŸ“¦ Tables affected:
 *   â€¢ tickers
 *   â€¢ data_validation_logs
 *
 * ============================================================================
 */
return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        /*
        |--------------------------------------------------------------------------
        | Extend tickers table
        |--------------------------------------------------------------------------
        */
        Schema::table('tickers', function (Blueprint $table) {
            // Pick the best reference column dynamically (some schemas use "active")
            $afterColumn = Schema::hasColumn('tickers', 'is_active')
                ? 'is_active'
                : (Schema::hasColumn('tickers', 'active') ? 'active' : 'status');

            if (!Schema::hasColumn('tickers', 'is_active_polygon')) {
                $table->boolean('is_active_polygon')
                    ->default(true)
                    ->after($afterColumn)
                    ->comment('Indicates if Polygon.io has valid upstream data for this ticker');
            }

            if (!Schema::hasColumn('tickers', 'deactivation_reason')) {
                $table->string('deactivation_reason', 255)
                    ->nullable()
                    ->after('is_active_polygon')
                    ->comment('Human-readable reason for deactivation (e.g. delisted, no_data_from_polygon)');
            }
        });

        /*
        |--------------------------------------------------------------------------
        | Extend data_validation_logs table
        |--------------------------------------------------------------------------
        */
        Schema::table('data_validation_logs', function (Blueprint $table) {
            if (!Schema::hasColumn('data_validation_logs', 'data_source_health')) {
                $table->json('data_source_health')
                    ->nullable()
                    ->after('details')
                    ->comment('JSON blob describing upstream API health or probe results');
            }
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('tickers', function (Blueprint $table) {
            if (Schema::hasColumn('tickers', 'is_active_polygon')) {
                $table->dropColumn('is_active_polygon');
            }
            if (Schema::hasColumn('tickers', 'deactivation_reason')) {
                $table->dropColumn('deactivation_reason');
            }
        });

        Schema::table('data_validation_logs', function (Blueprint $table) {
            if (Schema::hasColumn('data_validation_logs', 'data_source_health')) {
                $table->dropColumn('data_source_health');
            }
        });
    }
};

===== FILE: database/migrations/2025_11_02_183454_add_processed_jobs_to_job_batches_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Add the processed_jobs column to the job_batches table.
     *
     * This column was introduced in Laravel 10.8+ for more precise
     * batch progress tracking and to allow real-time % complete reporting.
     */
    public function up(): void
    {
        Schema::table('job_batches', function (Blueprint $table) {
            if (! Schema::hasColumn('job_batches', 'processed_jobs')) {
                $table->unsignedInteger('processed_jobs')->default(0)->after('failed_jobs');
            }
        });
    }

    /**
     * Reverse the migration changes.
     */
    public function down(): void
    {
        Schema::table('job_batches', function (Blueprint $table) {
            if (Schema::hasColumn('job_batches', 'processed_jobs')) {
                $table->dropColumn('processed_jobs');
            }
        });
    }
};

===== FILE: database/migrations/2025_11_02_184627_alter_data_validation_logs_status_enum.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {

    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('data_validation_logs', function (Blueprint $table) {
            $table->enum('status', ['running', 'success', 'warning', 'error'])
                ->default('running')
                ->change();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('data_validation_logs', function (Blueprint $table) {
            $table->enum('status', ['success', 'warning', 'error'])
                ->default('success')
                ->change();
        });
    }
};

===== FILE: database/migrations/2025_11_02_192801_add_status_to_job_batches_table.php =====

<?php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {

    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('job_batches', function (Blueprint $table) {
            // Add new status column with sensible default
            if (! Schema::hasColumn('job_batches', 'status')) {
                $table->string('status', 20)->default('running')->after('processed_jobs');
            }
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('job_batches', function (Blueprint $table) {
            if (Schema::hasColumn('job_batches', 'status')) {
                $table->dropColumn('status');
            }
        });
    }
};


===== FILE: database/migrations/2025_11_02_195538_fix_job_batches_schema_for_batches.php =====

<?php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

return new class extends Migration {
    public function up(): void
    {
        Schema::table('job_batches', function (Blueprint $table) {
            // Change `id` to UUID primary key (if not already)
            if (Schema::hasColumn('job_batches', 'id')) {
                DB::statement('ALTER TABLE job_batches MODIFY id CHAR(36) NOT NULL');
            } else {
                $table->uuid('id')->primary();
            }

            // Add processed_jobs if missing
            if (! Schema::hasColumn('job_batches', 'processed_jobs')) {
                $table->unsignedInteger('processed_jobs')->default(0)->after('failed_jobs');
            }

            // Add status column if missing
            if (! Schema::hasColumn('job_batches', 'status')) {
                $table->string('status', 20)->default('running')->after('processed_jobs');
            }
        });
    }

    public function down(): void
    {
        // revert optional
    }
};

===== FILE: database/migrations/2025_11_02_200228_rebuild_job_batches_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::dropIfExists('job_batches');

        Schema::create('job_batches', function (Blueprint $table) {
            // Core identifiers
            $table->string('id')->primary();
            $table->string('name');

            // Job tracking
            $table->integer('total_jobs');
            $table->integer('pending_jobs');
            $table->integer('failed_jobs');
            $table->integer('processed_jobs')->default(0);

            // Failure + options metadata
            $table->longText('failed_job_ids')->nullable()->default('[]');
            $table->mediumText('options')->nullable();

            // Batch lifecycle status
            $table->string('status')->default('running');

            // ðŸš€ Laravel Bus uses 32-bit UNIX timestamps for these columns.
            // Using plain integer avoids truncation / invalid datetime warnings.
            $table->integer('cancelled_at')->nullable();
            $table->integer('created_at');
            $table->integer('finished_at')->nullable();

            // Optional high-resolution tracking for your app (Eloquent safe)
            $table->timestamp('updated_at')->nullable();

            // Helpful indexes
            $table->index('created_at');
            $table->index('finished_at');
            $table->index('status');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('job_batches');
    }
};

===== FILE: database/migrations/2025_11_03_190343_alter_vw_precision_in_ticker_price_histories_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

/**
 * ============================================================================
 *  Migration: Increase precision for `vw` in ticker_price_histories
 * ============================================================================
 * Resolves occasional SQLSTATE[22003] numeric overflow errors when Polygon.io
 * returns large "volume-weighted average price" values (e.g., 2,448,000+).
 * This aligns `vw` with o/h/l/c decimal precision for uniformity.
 * ============================================================================
 */
return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('ticker_price_histories', function (Blueprint $table) {
            $table->decimal('vw', 16, 6)->nullable()->change();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('ticker_price_histories', function (Blueprint $table) {
            $table->decimal('vw', 12, 6)->nullable()->change();
        });
    }
};

===== FILE: database/migrations/2025_11_06_064645_create_ticker_validation_results_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('ticker_validation_results', function (Blueprint $table) {
            $table->id();
            $table->foreignId('ticker_id')
                ->constrained('tickers')
                ->onDelete('cascade');
            $table->string('validator', 50)
                ->comment('Validator name: price_history, indicators, metrics, snapshots, etc.');
            $table->enum('status', ['success', 'warning', 'error', 'insufficient', 'exception'])
                ->default('success');
            $table->decimal('health', 5, 3)->nullable()
                ->comment('Aggregate health score 0â€“1');
            $table->json('issues')->nullable()
                ->comment('JSON list or object of validation anomalies');
            $table->timestamp('validated_at')->useCurrent();
            $table->timestamps();

            $table->unique(['ticker_id', 'validator'], 'uq_tvr_ticker_validator');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('ticker_validation_results');
    }
};


===== FILE: database/migrations/2025_11_06_065039_add_log_id_to_ticker_validation_results_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('ticker_validation_results', function (Blueprint $table) {
            $table->foreignId('log_id')
                ->nullable()
                ->after('id')
                ->comment('References data_validation_logs.id for run-level context')
                ->constrained('data_validation_logs')
                ->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('ticker_validation_results', function (Blueprint $table) {
            $table->dropForeign(['log_id']);
            $table->dropColumn('log_id');
        });
    }
};

===== FILE: database/migrations/2025_11_07_004309_add_address_json_to_tickers_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

/**
 * Migration: Add address_json column to tickers table
 *
 * Purpose:
 *   - Store the structured address block returned by Polygon.ioâ€™s
 *     /v3/reference/tickers/{symbol} endpoint (address1, city, state, postal_code).
 *   - The column uses JSON type for flexibility and to support direct
 *     filtering via MariaDB/JSON functions.
 *
 * Example value:
 * {
 *   "address1": "One Apple Park Way",
 *   "city": "Cupertino",
 *   "state": "CA",
 *   "postal_code": "95014"
 * }
 */
return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        if (Schema::hasTable('tickers') && !Schema::hasColumn('tickers', 'address_json')) {
            Schema::table('tickers', function (Blueprint $table) {
                // JSON column for company address (optional, nullable)
                $table->json('address_json')
                      ->nullable()
                      ->after('branding_icon_url')
                      ->comment('Polygon.io structured address object');
            });
        }
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        if (Schema::hasTable('tickers') && Schema::hasColumn('tickers', 'address_json')) {
            Schema::table('tickers', function (Blueprint $table) {
                $table->dropColumn('address_json');
            });
        }
    }
};

===== FILE: database/migrations/2025_11_07_012719_remove_redundant_fields_from_ticker_overviews_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

/**
 * Migration: Remove redundant fields from ticker_overviews table
 *
 * Purpose:
 *   The `ticker_overviews` table originally duplicated two columns â€”
 *   `locale` and `primary_exchange` â€” which also exist in the `tickers` table.
 *   These values are static company metadata, not time-varying metrics,
 *   so they are being removed to prevent redundancy and ensure consistency.
 *
 * Notes:
 *   - Safe "hasColumn" checks are used to prevent errors during rollback.
 *   - This migration is backward-compatible with old data exports.
 */
return new class extends Migration
{
    /**
     * Run the migrations (remove redundant columns).
     */
    public function up(): void
    {
        if (Schema::hasTable('ticker_overviews')) {
            Schema::table('ticker_overviews', function (Blueprint $table) {
                if (Schema::hasColumn('ticker_overviews', 'locale')) {
                    $table->dropColumn('locale');
                }

                if (Schema::hasColumn('ticker_overviews', 'primary_exchange')) {
                    $table->dropColumn('primary_exchange');
                }
            });
        }
    }

    /**
     * Reverse the migrations (restore columns if rolled back).
     */
    public function down(): void
    {
        if (Schema::hasTable('ticker_overviews')) {
            Schema::table('ticker_overviews', function (Blueprint $table) {
                if (!Schema::hasColumn('ticker_overviews', 'locale')) {
                    $table->string('locale')->nullable()->after('market_cap')->index();
                }

                if (!Schema::hasColumn('ticker_overviews', 'primary_exchange')) {
                    $table->string('primary_exchange')->nullable()->after('market_cap')->index();
                }
            });
        }
    }
};

===== FILE: database/migrations/2025_11_07_014556_remove_market_cap_from_tickers_table.php =====

<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

/**
 * Migration: Remove market_cap from tickers table
 *
 * Purpose:
 *   - The `market_cap` field fluctuates frequently (daily/real-time),
 *     so it belongs in `ticker_overviews`, not `tickers`.
 *   - This migration safely removes the redundant column.
 */
return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        if (Schema::hasTable('tickers') && Schema::hasColumn('tickers', 'market_cap')) {
            Schema::table('tickers', function (Blueprint $table) {
                $table->dropColumn('market_cap');
            });
        }
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        if (Schema::hasTable('tickers') && !Schema::hasColumn('tickers', 'market_cap')) {
            Schema::table('tickers', function (Blueprint $table) {
                $table->unsignedBigInteger('market_cap')->nullable()->after('list_date')->index();
            });
        }
    }
};

[EOF: database/migrations (Part 2)]
